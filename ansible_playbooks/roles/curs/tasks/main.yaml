---
# create venv and install application
- name: check venv
  stat: path=~/{{ venv_dir }}/bin/activate
  register: venv_result

- block:
  - name: Initiate virtualenv for python3.5
    command: python3.5 -m venv --without-pip ~/{{ venv_dir }}
  - name: download get-pip.py
    get_url: url=https://bootstrap.pypa.io/get-pip.py
      dest=~/get-pip.py
      force=no
  - name: install pip3.5
    command: ~/{{ venv_dir }}/bin/python3.5 ~/get-pip.py
  when: not venv_result.stat.exists

# installing application
- name: install application
  pip: name='file://{{ home_dir }}/{{ app_file }}'
       virtualenv=~/{{ venv_dir}}
       virtualenv_python=python3.5
- name: generate logging.yaml
  template: src=logging.yml.j2 dest={{ home_dir }}/{{ venv_dir }}/.curs/logging.yml

# configure app
- block:
  - name: copy static files
    shell: cp -R {{ home_dir }}/{{ venv_dir }}/lib/python3.5/site-packages/app/static/* {{ static_path }}
    notify:
      - start uwsgi
      - start nginx

    # -------------- curs configs ---------------
  - block:
    - name: make /etc/curs directory
      command: mkdir -p {{ conf_dir }}
    - name: generate curs.conf from template
      template: src=curs.conf.j2 dest={{ conf_dir }}/curs.conf
    - name: copy uwsgi (curs) script to init.d
      command: cp {{ home_dir }}/{{ venv_dir }}/bin/curs /etc/init.d/curs
      notify:
        - start uwsgi
        - start nginx
    when: ansible_service_mgr == "upstart"

  - name: generate curs systemd config
    template: src=systemd.service.j2 dest=/etc/systemd/system/curs.service
    with_items:
      - "{{ curs }}"
    when: ansible_service_mgr == "systemd"
    notify:
      - start uwsgi
      - start nginx
      - start cursauto

  # -------------- cursauto configs ---------------
  - name: generate curs_auto  script into init.d
    template: src=init-script.j2 dest=/etc/init.d/curs_auto mode="a+x"
    # in ansible2 vars could be inside tasks
    vars:
      cmd: $dir/bin/curs_auto
      provider: curs_auto
      Required_Start: mongodb $network $syslog
    when: ansible_service_mgr == "upstart"
    notify:
      - start cursauto
  - name: generate cursauto systemd config
    template: src=systemd.service.j2 dest=/etc/systemd/system/cursauto.service
    with_items:
      - "{{ cursauto }}"
    when: ansible_service_mgr == "systemd"
    notify:
      - start cursauto
  become: yes
  become_method: sudo